{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mx-auto p-4 md:p-10 min-h-screen bg-gray-50 font-sans">
    <div class="max-w-4xl mx-auto">
        <!-- Заголовок -->
        <h1 class="text-4xl lg:text-5xl font-extrabold text-gray-900 mb-8 border-b-4 border-indigo-500 pb-3 flex items-center">
            <!-- Icon for Tender Document -->
            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 mr-3 text-indigo-600"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
            {{ tender.title }}
        </h1>
        
        <!-- СТАТУС ТЕНДЕРА И ПРЕДУПРЕЖДЕНИЯ -->
        {% with status_classes='bg-gray-100 border-gray-600 text-gray-800' %}
            {% if tender.status == 'active' %}
                {% with status_classes='bg-green-50 border-green-600 text-green-800' icon_svg='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-green-600"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>' %}
                {% endwith %}
            {% elif tender.status == 'closed' %} 
                {% with status_classes='bg-yellow-50 border-yellow-600 text-yellow-800' icon_svg='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-yellow-600"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>' %}
                {% endwith %}
            {% elif tender.status == 'awarded' %} 
                {% with status_classes='bg-blue-50 border-blue-600 text-blue-800' icon_svg='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-blue-600"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>' %}
                {% endwith %}
            {% endif %}
        
            <div class="mb-8 p-5 rounded-xl shadow-lg border-l-8 {{ status_classes }}">
                <p class="font-bold text-xl flex items-center">
                    {% autoescape off %}{{ icon_svg }}{% endautoescape off %}
                    Статус: <span class="uppercase ml-2 font-extrabold">{{ tender.get_status_display }}</span>
                </p>
                <p class="text-sm mt-2 text-gray-700">
                    <span class="font-medium">Создан: **{{ tender.creator.username }}**</span> 
                    (Дата: {{ tender.created_at|date:"d.m.Y H:i" }})
                </p>
            </div>
        {% endwith %}

        <!-- ИНФОРМАЦИЯ О ПОБЕДИТЕЛЕ (ТОЛЬКО ЕСЛИ НАГРАЖДЕН) -->
        {% if tender.status == 'awarded' and winner_bid %}
        <div class="bg-indigo-100 border-l-8 border-indigo-700 text-indigo-900 p-5 rounded-xl mb-8 shadow-2xl">
            <h2 class="text-2xl font-bold mb-3 flex items-center text-indigo-900">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-indigo-700"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                Победитель Тендера
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <p class="text-lg"><strong>Победитель:</strong> <span class="font-semibold">{{ winner_bid.bidder.username }}</span></p>
                <p class="text-lg">
                    <strong>Окончательная Цена:</strong> 
                    <span class="font-extrabold text-2xl text-green-700">{{ winner_bid.price }}</span> 
                    ({{ tender.get_budget_currency_display }})
                </p>
            </div>
            <p class="text-sm mt-3 text-indigo-700 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1"><rect x="5" y="3" width="14" height="18" rx="2"></rect><path d="M12 17V7"></path><path d="M9 13H7"></path><path d="M17 13H15"></path></svg>
                Решение запечатано в блокчейне.
            </p>
        </div>
        {% endif %}

        <!-- ОПИСАНИЕ И ДЕТАЛИ -->
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl mb-10 border border-gray-100">
            <h2 class="text-3xl font-bold mb-5 text-gray-800 border-b pb-2 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2 text-red-500"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L15 2z"></path><path d="M14 2v6h6"></path><path d="M10 13H8"></path><path d="M16 13h-2"></path><path d="M16 17H8"></path></svg>
                Детали Задания
            </h2>
            
            <!-- Описание -->
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-2 text-gray-600">Описание</h3>
                <p class="text-gray-700 leading-relaxed bg-gray-50 p-4 rounded-lg border border-gray-200 shadow-inner">{{ tender.description }}</p>
            </div>

            <!-- Характеристики -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-lg border-t pt-4">
                <div class="flex flex-col p-3 bg-blue-50 rounded-lg">
                    <strong class="text-gray-600 mb-1 flex items-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1 text-blue-600"><path d="M12 20h.01"></path><path d="M12 16h.01"></path><path d="M12 12h.01"></path><path d="M12 8h.01"></path><path d="M12 4h.01"></path></svg>
                        Максимальный Бюджет
                    </strong>
                    <p class="text-2xl font-extrabold text-blue-700">{{ tender.budget }} <span class="text-xl font-semibold text-blue-500">{{ tender.get_budget_currency_display }}</span></p>
                </div>
                <div class="flex flex-col p-3 bg-red-50 rounded-lg">
                    <strong class="text-gray-600 mb-1 flex items-center text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1 text-red-600"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        Дедлайн
                    </strong>
                    <p class="text-xl font-bold text-red-600">{{ tender.deadline|date:"d.m.Y H:i" }}</p>
                </div>
            </div>
        </div>
        
        
        {% if is_creator %}
            <!-- ФОРМА РЕДАКТИРОВАНИЯ (ТОЛЬКО ДЛЯ СОЗДАТЕЛЯ) -->
            {% if tender.status == 'active' %}
            <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl mb-10 border-t-8 border-blue-600">
                <h2 class="text-3xl font-bold mb-6 text-blue-700 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7 mr-2 text-blue-500"><path d="M12 20h.01"></path><path d="M12 16h.01"></path><path d="M12 12h.01"></path><path d="M12 8h.01"></path><path d="M12 4h.01"></path></svg>
                    Редактирование Тендера (Вы — Создатель)
                </h2>
                <form method="post">
                    {% csrf_token %}
                    {% for field in tender_form %}
                    <div class="mb-5">
                        <label for="{{ field.id_for_label }}" class="block text-gray-700 text-base font-medium mb-2">{{ field.label }}:</label>
                        <!-- ПРЕДЛОЖЕНИЕ: Добавьте следующие классы к полям формы через виджеты Django -->
                        {{ field }}
                        {% for error in field.errors %}
                            <p class="text-red-600 text-sm italic mt-1 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                {{ error }}
                            </p>
                        {% endfor %}
                    </div>
                    {% endfor %}
                    <button type="submit" name="tender_edit_submit" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-extrabold py-3 px-8 rounded-lg shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-200 transform hover:scale-[1.01] mt-4 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                        Сохранить Изменения
                    </button>
                    {% if not tender.bids.exists %}
                        <a href="{% url 'tender_delete' tender.pk %}" 
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                            Удалить тендер
                        </a>
                        {% else %}
                        <button disabled 
                                class="bg-gray-400 text-white px-4 py-2 rounded cursor-not-allowed"
                                title="Нельзя удалить тендер с заявками">
                            Удалить тендер
                        </button>
                    {% endif %}
                </form>
            </div>
            {% else %}
            <!-- СООБЩЕНИЕ ДЛЯ СОЗДАТЕЛЯ, ЕСЛИ НЕ АКТИВЕН -->
            <div class="bg-gray-200 p-5 rounded-xl text-gray-700 mb-10 border border-gray-300 shadow-md flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-gray-600"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="16" x2="12.01" y2="16"></line><line x1="12" y1="8" x2="12" y2="12"></line></svg>
                <p class="font-medium text-lg">Тендер **{{ tender.get_status_display|upper }}**. Редактирование невозможно.</p>
            </div>
            {% endif %}

            <!-- СПИСОК ЗАЯВОК (ТОЛЬКО ДЛЯ СОЗДАТЕЛЯ) -->
            <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl mb-8 border border-gray-100">
                <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7 mr-2 text-purple-600"><path d="M12 20h.01"></path><path d="M12 16h.01"></path><path d="M12 12h.01"></path><path d="M12 8h.01"></path><path d="M12 4h.01"></path></svg>
                    Все Заявки (Биды) ({{ bids.count }})
                </h2>
                {% if bids %}
                <div class="overflow-x-auto shadow-lg rounded-lg border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-indigo-100">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-extrabold text-indigo-800 uppercase tracking-wider rounded-tl-lg">Участник</th>
                                <th class="px-6 py-4 text-left text-xs font-extrabold text-indigo-800 uppercase tracking-wider">Цена</th>
                                <th class="px-6 py-4 text-left text-xs font-extrabold text-indigo-800 uppercase tracking-wider">Предложение</th>
                                <th class="px-6 py-4 text-left text-xs font-extrabold text-indigo-800 uppercase tracking-wider">Дата</th>
                                {% if tender.status == 'awarded' %}
                                <th class="px-6 py-4 text-left text-xs font-extrabold text-indigo-800 uppercase tracking-wider rounded-tr-lg">Статус</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">
                            {% for bid in bids %}
                            <tr class="hover:bg-indigo-50 transition duration-100 
                                {% if tender.status == 'awarded' and bid == winner_bid %} 
                                    bg-yellow-100 font-semibold border-l-4 border-yellow-500 
                                {% endif %}">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ bid.bidder.username }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-base font-bold 
                                    {% if tender.status == 'awarded' and bid == winner_bid %} text-green-700 {% else %} text-gray-800 {% endif %}">
                                    {{ bid.price }} {{ tender.get_budget_currency_display }}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ bid.proposal|truncatechars:50 }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ bid.timestamp|date:"d.m.Y H:i" }}</td>
                                {% if tender.status == 'awarded' %}
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    {% if tender.status == 'awarded' and winner_bid and user == tender.creator or user == winner_bid.bidder %}
                                        <a href="{% url 'download_contract' tender.pk %}" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs">
                                            📄 Контракт
                                        </a>
                                    {% else %}
                                        <span class="text-gray-400">—</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-gray-500 text-lg p-4 bg-indigo-50 rounded-lg border border-indigo-200 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2 text-indigo-500"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="20" x2="4" y2="11"></line><line x1="20" y1="20" x2="20" y2="11"></line></svg>
                    Заявок пока нет. Будьте первым, кто подаст заявку!
                </p>
                {% endif %}
            </div>
        
        {% else %}
            <!-- ФОРМА ПОДАЧИ ЗАЯВКИ (ТОЛЬКО ДЛЯ НЕ-СОЗДАТЕЛЕЙ) -->
            {% if tender.status == 'active' %}
                {% if not bid_placed %}
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl mb-10 border-t-8 border-green-600">
                    <h2 class="text-3xl font-bold mb-6 text-green-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7 mr-2 text-green-500"><path d="M12 20h.01"></path><path d="M12 16h.01"></path><path d="M12 12h.01"></path><path d="M12 8h.01"></path><path d="M12 4h.01"></path></svg>
                        Подать Вашу Заявку (Бид)
                    </h2>
                    <form method="post">
                        {% csrf_token %}
                        {% for field in bid_form %}
                        <div class="mb-5">
                            <label for="{{ field.id_for_label }}" class="block text-gray-700 text-base font-medium mb-2">{{ field.label }}:</label>
                            <!-- ПРЕДЛОЖЕНИЕ: Добавьте следующие классы к полям формы через виджеты Django -->
                            {{ field }}
                            {% for error in field.errors %}
                                <p class="text-red-600 text-sm italic mt-1 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                    {{ error }}
                                </p>
                            {% endfor %}
                        </div>
                        {% endfor %}
                        <button type="submit" name="bid_submit" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-extrabold py-3 px-8 rounded-lg shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-green-300 transition duration-200 transform hover:scale-[1.01] mt-4 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            Подать Заявку
                        </button>
                    </form>
                </div>
                {% else %}
                <!-- СООБЩЕНИЕ О ПОДАННОЙ ЗАЯВКЕ -->
                <div class="bg-green-100 border-l-8 border-green-600 text-green-800 p-5 rounded-xl mb-10 shadow-md">
                    <p class="font-medium text-lg flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-green-600"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        Вы уже подали заявку на этот тендер. Ждите решения организатора.
                    </p>
                </div>
                {% endif %}
            {% else %}
                <!-- СООБЩЕНИЕ О НЕАКТИВНОМ ТЕНДЕРЕ -->
                <div class="bg-gray-200 p-5 rounded-xl text-gray-700 mb-10 border border-gray-300 shadow-md flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-gray-600"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="16" x2="12.01" y2="16"></line><line x1="12" y1="8" x2="12" y2="12"></line></svg>
                    <p class="font-medium text-lg">Тендер не активен (Статус: **{{ tender.get_status_display|upper }}**). Подача заявок невозможна.</p>
                </div>
            {% endif %}
        {% endif %}

    </div>
</div>
{% endblock content %}
